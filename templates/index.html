<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Developer Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .log-container {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1a1a1a;
            color: #00ff00;
        }
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        .log-line {
            padding: 2px 0;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-line-claude { color: #fbbf24; }
        .log-line-error { color: #ef4444; }
        .log-line-success { color: #10b981; }
        .log-line-info { color: #3b82f6; }
        .log-line-warning { color: #f59e0b; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // Simple toast implementation
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, type === 'error' ? 5000 : 3000);
                return () => clearTimeout(timer);
            }, [onClose, type]);
            
            return (
                <div className={`toast toast-${type}`} onClick={onClose}>
                    {message}
                </div>
            );
        };
        
        // Toast hook
        const useToast = () => {
            const [toasts, setToasts] = useState([]);
            
            const addToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };
            
            const removeToast = (id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            };
            
            const toast = {
                success: (message) => addToast(message, 'success'),
                error: (message) => addToast(message, 'error'),
                info: (message) => addToast(message, 'info')
            };
            
            const ToastContainer = () => (
                <div>
                    {toasts.map(toast => (
                        <Toast
                            key={toast.id}
                            message={toast.message}
                            type={toast.type}
                            onClose={() => removeToast(toast.id)}
                        />
                    ))}
                </div>
            );
            
            return { toast, ToastContainer };
        };
        
        // Local storage keys
        const STORAGE_KEYS = {
            devpodName: 'rd_devpod_name',
            githubRepo: 'rd_github_repo',
            githubToken: 'rd_github_token'
        };
        
        // Global debug function to test EventSource manually
        window.testEventSource = function(taskId) {
            console.log('Manual EventSource test for taskId:', taskId);
            const es = new EventSource(`/api/task-logs/${taskId}/stream`);
            es.onopen = (e) => console.log('Manual ES opened:', e);
            es.onmessage = (e) => console.log('Manual ES message:', e.data);
            es.onerror = (e) => console.log('Manual ES error:', e);
            window.testES = es;
            return es;
        };
        
        // Task component
        const Task = ({ task, taskId, onCommit, onCreatePR }) => {
            console.log('Task component rendered with taskId:', taskId, 'task status:', task.status);
            const [logs, setLogs] = useState(task.logs || []);
            const [showLogs, setShowLogs] = useState(true); // Always show logs by default
            const [isStreaming, setIsStreaming] = useState(false);
            const logsEndRef = useRef(null);
            const eventSourceRef = useRef(null);
            
            const scrollToBottom = () => {
                logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            // Removed auto-scroll on logs update for better UX
            // useEffect(() => {
            //     scrollToBottom();
            // }, [logs]);
            
            const getLogLineClass = (log) => {
                if (log.includes('CLAUDE') || log.includes('Claude')) return 'log-line-claude';
                if (log.includes('Error:') || log.includes('❌')) return 'log-line-error';
                if (log.includes('✅') || log.includes('completed')) return 'log-line-success';
                if (log.includes('⚠️') || log.includes('warning')) return 'log-line-warning';
                if (log.includes('📦') || log.includes('🔧')) return 'log-line-info';
                return '';
            };
            
            const startLogStream = useCallback(() => {
                if (isStreaming || eventSourceRef.current) {
                    console.log(`Stream already active for ${taskId}, skipping`);
                    return;
                }
                
                if (!taskId) {
                    console.log('No taskId available, cannot start stream');
                    return;
                }
                
                console.log(`Starting log stream for task ${taskId}`);
                setIsStreaming(true);
                
                const streamUrl = `/api/task-logs/${taskId}/stream`;
                console.log(`Creating EventSource for URL: ${streamUrl}`);
                
                const eventSource = new EventSource(streamUrl);
                eventSourceRef.current = eventSource;
                
                eventSource.onopen = (event) => {
                    console.log(`EventSource connection opened for ${taskId}:`, event);
                };
                
                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log(`Log received for ${taskId}:`, data);
                        
                        if (data.log) {
                            setLogs(prev => [...prev, data.log]);
                        }
                        
                        if (data.complete) {
                            console.log(`Stream complete for ${taskId}`);
                            eventSource.close();
                            setIsStreaming(false);
                            eventSourceRef.current = null;
                        }
                    } catch (error) {
                        console.error('Error parsing SSE data:', error);
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('SSE Error for task', taskId, ':', error);
                    console.log('EventSource readyState:', eventSource.readyState);
                    setLogs(prev => [...prev, '--- Stream disconnected ---']);
                    eventSource.close();
                    setIsStreaming(false);
                    eventSourceRef.current = null;
                };
                
                // Load initial logs if available
                if (task.logs && task.logs.length > 0) {
                    setLogs(task.logs);
                }
            }, [taskId]);
            
            // Update logs when task logs change
            useEffect(() => {
                if (task.logs && task.logs.length > logs.length && !isStreaming) {
                    setLogs(task.logs);
                }
            }, [task.logs, logs.length, isStreaming]);
            
            // Start streaming when component mounts for running tasks
            useEffect(() => {
                console.log(`useEffect for auto-start: taskId=${taskId}, task.status=${task.status}, isStreaming=${isStreaming}, eventSourceExists=${!!eventSourceRef.current}`);
                
                // Force start stream if task is running but no EventSource exists
                if (task.status !== 'completed' && task.status !== 'failed') {
                    if (!eventSourceRef.current) {
                        console.log(`Force starting stream for running task ${taskId} (no EventSource exists)`);
                        setIsStreaming(false); // Reset streaming state
                        startLogStream();
                    } else {
                        console.log(`EventSource already exists for ${taskId}`);
                    }
                } else {
                    console.log(`Not auto-starting stream: status=${task.status}, isStreaming=${isStreaming}`);
                }
            }, [task.status, taskId]);
            
            // Handle log visibility toggle
            useEffect(() => {
                if (showLogs && !isStreaming && task.status !== 'completed' && task.status !== 'failed') {
                    startLogStream();
                }
                
                return () => {
                    if (eventSourceRef.current) {
                        eventSourceRef.current.close();
                        eventSourceRef.current = null;
                    }
                };
            }, [showLogs, task.status]);
            
            const statusColors = {
                'completed': 'text-green-600',
                'failed': 'text-red-600',
                'executing_task': 'text-purple-600',
                'checking_server': 'text-indigo-600',
                'creating_devpod': 'text-blue-600',
                'cloning_repository': 'text-cyan-600',
                'setting_up_claude': 'text-yellow-600',
                'preparing_workspace': 'text-pink-600',
                'reviewing_changes': 'text-orange-600',
                'interrupted': 'text-gray-600'
            };
            
            const statusColor = statusColors[task.status] || 'text-gray-600';
            
            return (
                <div className="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex-1">
                            <h3 className="font-semibold text-lg">{task.devpod_name}</h3>
                            <p className="text-sm text-gray-600 mt-1">{task.task_description}</p>
                        </div>
                        <div className="text-right ml-4">
                            <span className={`text-sm font-medium ${statusColor}`}>
                                {task.status.replace(/_/g, ' ')}
                            </span>
                            {task.claude_status && (
                                <div className="text-xs text-yellow-600 mt-1">
                                    Claude: {task.claude_status}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div 
                            className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500"
                            style={{ width: `${task.progress}%` }}
                        />
                    </div>
                    
                    <div className="flex items-center justify-between mb-2">
                        <button
                            onClick={() => setShowLogs(!showLogs)}
                            className="text-xs text-blue-500 hover:text-blue-700 focus:outline-none"
                        >
                            {showLogs ? '▼ Hide Logs' : '▶ Show Logs'} ({logs.length} lines)
                        </button>
                        
                        {task.app_url && (
                            <a
                                href={task.app_url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors"
                            >
                                <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                Open App
                            </a>
                        )}
                    </div>
                    
                    {showLogs && (
                        <div className="log-container rounded p-3 overflow-y-auto" style={{ maxHeight: '400px', minHeight: '100px' }}>
                            {logs.length === 0 ? (
                                <div className="text-gray-500 text-sm">Waiting for logs...</div>
                            ) : (
                                logs.map((log, index) => (
                                    <div key={index} className={`log-line ${getLogLineClass(log)}`}>
                                        {log}
                                    </div>
                                ))
                            )}
                            <div ref={logsEndRef} />
                        </div>
                    )}
                    
                    {task.status === 'completed' && (
                        <div className="mt-3">
                            <div className="text-sm text-gray-600 mb-2">
                                Branch: {task.current_branch || 'main'}
                            </div>
                            
                            {task.has_changes && (
                                <div className="flex gap-2 mt-2">
                                    {!task.is_committed && (
                                        <button
                                            onClick={() => onCommit(taskId)}
                                            className="px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600 transition-colors"
                                        >
                                            Commit Changes
                                        </button>
                                    )}
                                    
                                    {task.is_committed && (
                                        <button
                                            onClick={() => onCreatePR(taskId)}
                                            className="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
                                        >
                                            Create PR
                                        </button>
                                    )}
                                </div>
                            )}
                            
                            {task.modified_files && task.modified_files.length > 0 && (
                                <div className="mt-2 text-xs text-gray-500">
                                    <div className="font-medium">Modified files:</div>
                                    <ul className="mt-1">
                                        {task.modified_files.map((file, idx) => (
                                            <li key={idx} className="font-mono">{file}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        // Main App component
        const App = () => {
            const [tasks, setTasks] = useState({});
            const [stats, setStats] = useState({
                total: 0,
                running: 0,
                completed: 0,
                failed: 0
            });
            const [formData, setFormData] = useState({
                devpod_name: localStorage.getItem(STORAGE_KEYS.devpodName) || '',
                github_repo: localStorage.getItem(STORAGE_KEYS.githubRepo) || '',
                github_token: localStorage.getItem(STORAGE_KEYS.githubToken) || '',
                task_description: ''
            });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const { toast, ToastContainer } = useToast();
            
            // Update dashboard
            const updateDashboard = async () => {
                try {
                    const response = await axios.get('/api/dashboard');
                    const data = response.data;
                    
                    setStats({
                        total: data.total_tasks,
                        running: data.running_tasks,
                        completed: data.completed_tasks,
                        failed: data.failed_tasks
                    });
                    
                    // Update tasks
                    const newTasks = {};
                    data.recent_tasks.forEach(task => {
                        newTasks[task.task_id] = task;
                    });
                    setTasks(newTasks);
                } catch (error) {
                    console.error('Dashboard update error:', error);
                    toast.error('Failed to update dashboard');
                }
            };
            
            useEffect(() => {
                updateDashboard();
                const interval = setInterval(updateDashboard, 3000);
                return () => clearInterval(interval);
            }, []);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                
                try {
                    // Save to localStorage
                    localStorage.setItem(STORAGE_KEYS.devpodName, formData.devpod_name);
                    localStorage.setItem(STORAGE_KEYS.githubRepo, formData.github_repo);
                    localStorage.setItem(STORAGE_KEYS.githubToken, formData.github_token);
                    
                    const response = await axios.post('/api/create-task', formData);
                    const taskId = response.data.task_id;
                    
                    toast.success(`Task created: ${taskId}`);
                    
                    // Clear only task description
                    setFormData(prev => ({ ...prev, task_description: '' }));
                    
                    // Immediate update
                    updateDashboard();
                } catch (error) {
                    toast.error(error.response?.data?.error || 'Failed to create task');
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const handleInputChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };
            
            // Helper functions for commit and PR
            const handleCommit = async (taskId) => {
                const task = tasks[taskId];
                const commitMessage = prompt('Enter commit message:', `Task: ${task.task_description}`);
                if (!commitMessage) return;
                
                try {
                    const response = await axios.post(`/api/task/${taskId}/commit`, {
                        commit_message: commitMessage
                    });
                    
                    if (response.data.status === 'success') {
                        showToast('Changes committed successfully', 'success');
                        // Refresh task status
                        fetchTasks();
                    }
                } catch (error) {
                    showToast(error.response?.data?.error || 'Failed to commit changes', 'error');
                }
            };
            
            const handleCreatePR = async (taskId) => {
                const task = tasks[taskId];
                const prTitle = prompt('PR Title:', `Task: ${task.task_description.substring(0, 50)}...`);
                if (!prTitle) return;
                
                const prBody = prompt('PR Description:', `Automated task execution:\n\n${task.task_description}`);
                if (!prBody) return;
                
                try {
                    const response = await axios.post(`/api/task/${taskId}/create-pr`, {
                        pr_title: prTitle,
                        pr_body: prBody,
                        github_token: localStorage.getItem('github_token') || task.github_token
                    });
                    
                    if (response.data.status === 'success') {
                        showToast('Pull Request created successfully', 'success');
                        if (response.data.pr_url) {
                            window.open(response.data.pr_url, '_blank');
                        }
                    }
                } catch (error) {
                    showToast(error.response?.data?.error || 'Failed to create PR', 'error');
                }
            };
            
            return (
                <div className="min-h-screen bg-gray-50">
                    <ToastContainer />
                    
                    <div className="container mx-auto p-4 max-w-7xl">
                        <h1 className="text-3xl font-bold mb-6 text-gray-800">Remote Developer Dashboard</h1>
                        
                        {/* Stats */}
                        <div className="grid grid-cols-4 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                <h3 className="text-gray-500 text-sm font-medium">Total Tasks</h3>
                                <p className="text-2xl font-bold mt-1">{stats.total}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                <h3 className="text-gray-500 text-sm font-medium">Running</h3>
                                <p className="text-2xl font-bold text-blue-600 mt-1">{stats.running}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                <h3 className="text-gray-500 text-sm font-medium">Completed</h3>
                                <p className="text-2xl font-bold text-green-600 mt-1">{stats.completed}</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-sm">
                                <h3 className="text-gray-500 text-sm font-medium">Failed</h3>
                                <p className="text-2xl font-bold text-red-600 mt-1">{stats.failed}</p>
                            </div>
                        </div>
                        
                        {/* Create Task Form */}
                        <div className="bg-white p-6 rounded-lg shadow-sm mb-6">
                            <h2 className="text-xl font-semibold mb-4">Create New Task</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        DevPod Name
                                    </label>
                                    <input
                                        type="text"
                                        name="devpod_name"
                                        value={formData.devpod_name}
                                        onChange={handleInputChange}
                                        required
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., auto-worker-demo"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        GitHub Repository
                                    </label>
                                    <input
                                        type="text"
                                        name="github_repo"
                                        value={formData.github_repo}
                                        onChange={handleInputChange}
                                        required
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., username/repository"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        GitHub Token
                                    </label>
                                    <input
                                        type="password"
                                        name="github_token"
                                        value={formData.github_token}
                                        onChange={handleInputChange}
                                        required
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="ghp_..."
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Task Description
                                    </label>
                                    <textarea
                                        name="task_description"
                                        value={formData.task_description}
                                        onChange={handleInputChange}
                                        required
                                        rows="3"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Describe what you want Claude to do..."
                                    />
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className={`px-4 py-2 rounded-md text-white font-medium transition-colors ${
                                        isSubmitting 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-blue-500 hover:bg-blue-600'
                                    }`}
                                >
                                    {isSubmitting ? 'Creating...' : 'Create Task'}
                                </button>
                            </form>
                        </div>
                        
                        {/* Active Tasks */}
                        <div className="bg-white p-6 rounded-lg shadow-sm">
                            <h2 className="text-xl font-semibold mb-4">Active Tasks</h2>
                            <div className="space-y-4">
                                {Object.keys(tasks).length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">No tasks yet</p>
                                ) : (
                                    Object.entries(tasks)
                                        .sort((a, b) => new Date(b[1].created_at) - new Date(a[1].created_at))
                                        .map(([taskId, task]) => (
                                            <Task 
                                                key={taskId} 
                                                taskId={taskId} 
                                                task={task} 
                                                onCommit={handleCommit}
                                                onCreatePR={handleCreatePR}
                                            />
                                        ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>